# Azure DevOps Pipeline for Terraform Infrastructure
# Auto-generated by Infrastructure Accelerator

trigger:
  branches:
    include:
      - main
      - master
  paths:
    include:
{%- for component in components %}
      - infra/{{ component }}/*
{%- endfor %}
      - infra/config/*

pr:
  branches:
    include:
      - main
      - master
  paths:
    include:
{%- for component in components %}
      - infra/{{ component }}/*
{%- endfor %}
      - infra/config/*

parameters:
  - name: environment
    displayName: 'Environment to deploy'
    type: string
    default: 'dev'
    values:
{%- for env in environments %}
      - {{ env }}
{%- endfor %}
  - name: component
    displayName: 'Component to deploy'
    type: string
    default: '{{ components[0] }}'
    values:
{%- for component in components %}
      - {{ component }}
{%- endfor %}
  - name: action
    displayName: 'Terraform action'
    type: string
    default: 'plan'
    values:
      - plan
      - apply

variables:
  - name: terraformVersion
    value: '1.10.3'
  - name: awsRegion
    value: '$(AWS_REGION)'

stages:
{%- for component in components %}
  - stage: Validate_{{ component }}
    displayName: 'Validate {{ component }}'
    condition: or(eq(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.Reason'], 'IndividualCI'))
    jobs:
      - job: ValidateJob
        displayName: 'Validate Terraform'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - script: |
              cd infra/{{ component }}
              terraform fmt -check -recursive
            displayName: 'Terraform Format Check'

          - script: |
              cd infra/{{ component }}
              terraform init -backend=false
            displayName: 'Terraform Init'

          - script: |
              cd infra/{{ component }}
              terraform validate
            displayName: 'Terraform Validate'

{%- for env in environments %}

  - stage: Plan_{{ component }}_{{ env }}
    displayName: 'Plan {{ component }} ({{ env }})'
    dependsOn: Validate_{{ component }}
    condition: |
      and(
        succeeded(),
        or(
          eq(variables['Build.Reason'], 'PullRequest'),
          and(
            eq(variables['Build.Reason'], 'Manual'),
            eq(parameters.component, '{{ component }}'),
            eq(parameters.environment, '{{ env }}')
          )
        )
      )
    jobs:
      - job: PlanJob
        displayName: 'Terraform Plan'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - script: |
              cd infra/{{ component }}
              terraform init
            displayName: 'Terraform Init'
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_REGION: $(awsRegion)

          - script: |
              cd infra/{{ component }}
              terraform plan \
                -var-file=../config/{{ env }}.tfvars \
                -out=tfplan-{{ env }} \
                -no-color
            displayName: 'Terraform Plan'
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_REGION: $(awsRegion)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Plan Artifact'
            inputs:
              targetPath: 'infra/{{ component }}/tfplan-{{ env }}'
              artifactName: 'tfplan-{{ component }}-{{ env }}'

  - stage: Apply_{{ component }}_{{ env }}
    displayName: 'Apply {{ component }} ({{ env }})'
    dependsOn: Plan_{{ component }}_{{ env }}
    condition: |
      and(
        succeeded(),
        or(
          and(
            eq(variables['Build.SourceBranch'], 'refs/heads/main'),
            eq(variables['Build.Reason'], 'IndividualCI')
          ),
          and(
            eq(variables['Build.Reason'], 'Manual'),
            eq(parameters.component, '{{ component }}'),
            eq(parameters.environment, '{{ env }}'),
            eq(parameters.action, 'apply')
          )
        )
      )
    jobs:
      - deployment: ApplyJob
        displayName: 'Terraform Apply'
        pool:
          vmImage: 'ubuntu-latest'
        environment: {{ env }}
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(terraformVersion)

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Plan Artifact'
                  inputs:
                    artifactName: 'tfplan-{{ component }}-{{ env }}'
                    targetPath: 'infra/{{ component }}'

                - script: |
                    cd infra/{{ component }}
                    terraform init
                  displayName: 'Terraform Init'
                  env:
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_REGION: $(awsRegion)

                - script: |
                    cd infra/{{ component }}
                    terraform apply -auto-approve tfplan-{{ env }}
                  displayName: 'Terraform Apply'
                  env:
                    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
                    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
                    AWS_REGION: $(awsRegion)
{%- endfor %}
{%- endfor %}
