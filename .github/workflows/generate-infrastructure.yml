name: Generate Infrastructure Template (MVP)

run-name: Generate "${{ inputs.project_name }}" infrastructure

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (used for naming resources)'
        required: true
        type: string

      components:
        description: 'Components (comma-separated: vpc,eks-auto)'
        required: true
        type: string
        default: 'vpc,eks-auto'

      environments:
        description: 'Environments (comma-separated: dev,uat,prod)'
        required: true
        type: string
        default: 'dev,uat,prod'

      region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'

      aws_account_id:
        description: 'AWS Account ID'
        required: true
        type: string
        default: ''

      repository:
        description: 'Repository name for resource tagging (e.g., infrastructure-accelerator)'
        required: false
        type: string
        default: 'infrastructure-accelerator'

      ci_provider:
        description: 'CI/CD provider (gitlab, github, azuredevops)'
        required: false
        type: choice
        default: 'gitlab'
        options:
          - gitlab
          - github
          - azuredevops

      availability_zones:
        description: 'Number of Availability Zones (1-3)'
        required: false
        type: choice
        default: '3'
        options:
          - '1'
          - '2'
          - '3'

      vpc_cidrs:
        description: 'VPC CIDRs per environment (JSON format: {"dev":"10.0.0.0/16","staging":"10.1.0.0/16","prod":"10.2.0.0/16"})'
        required: false
        type: string
        default: ''

# Prevent concurrent runs for the same workflow
concurrency:
  group: generate-infra-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# Minimal permissions following principle of least privilege
permissions:
  contents: read
  actions: read

env:
  PYTHON_VERSION: '3.12'  # Consistent Python version across all workflows
  TERRAFORM_VERSION: '1.10.3'  # Latest stable Terraform version

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Job-specific permissions for artifact upload
    permissions:
      contents: read
      actions: write  # Required for uploading artifacts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install jinja2 pyyaml

      - name: Generate infrastructure
        run: |
          python3 scripts/generators/generate_infrastructure.py \
            --project-name "${{ inputs.project_name }}" \
            --components "${{ inputs.components }}" \
            --environments "${{ inputs.environments }}" \
            --region "${{ inputs.region }}" \
            --aws-account-id "${{ inputs.aws_account_id }}" \
            --repository "${{ inputs.repository }}" \
            --ci-provider "${{ inputs.ci_provider }}" \
            --availability-zones "${{ inputs.availability_zones }}" \
            ${{ inputs.vpc_cidrs != '' && format('--vpc-cidrs "{0}"', inputs.vpc_cidrs) || '' }} \
            --output-dir generated-infra

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Validate Terraform - Init
        run: |
          echo "Validating generated Terraform code..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Initializing $component..."

              cd "$dir"

              # Initialize without backend (for validation only)
              terraform init -backend=false || {
                echo "âŒ Failed to initialize $component"
                exit 1
              }

              cd - > /dev/null
            fi
          done

      - name: Validate Terraform - Format Check
        run: |
          echo "Checking Terraform formatting..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Checking format for $component..."

              cd "$dir"

              if ! terraform fmt -check -recursive; then
                echo "âš ï¸  Warning: $component has formatting issues"
                echo "Running terraform fmt to fix..."
                terraform fmt -recursive
              fi

              cd - > /dev/null
            fi
          done

      - name: Validate Terraform - Validate
        run: |
          echo "Validating Terraform configuration..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Validating $component..."

              cd "$dir"

              terraform validate || {
                echo "âŒ Failed to validate $component"
                exit 1
              }

              cd - > /dev/null
            fi
          done

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run tflint
        run: |
          echo "Running tflint..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Linting $component..."

              cd "$dir"
              tflint --init
              tflint || echo "âš ï¸  tflint found issues in $component"
              cd - > /dev/null
            fi
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install gitlab-ci-local
        run: |
          npm install -g gitlab-ci-local

      - name: Validate CI/CD configuration
        run: |
          cd generated-infra

          # Clean up .terraform directories and lock files to avoid git warnings about embedded repos
          echo "Cleaning up .terraform directories and lock files..."
          find . -type d -name ".terraform" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name ".terraform.lock.hcl" -delete 2>/dev/null || true
          echo "âœ… Cleanup complete"
          echo ""

          # Validate based on CI provider
          if [ "${{ inputs.ci_provider }}" = "gitlab" ]; then
            # Initialize git repo for gitlab-ci-local to work properly
            git init
            git config user.email "ci@example.com"
            git config user.name "CI"
            git add .
            git commit -m "Initial commit"

            echo "Validating GitLab CI configuration..."
            echo ""
            gitlab-ci-local --list-all

            echo ""
            echo "Validating job dependency chain..."
            gitlab-ci-local --validate-dependency-chain

            echo ""
            echo "âœ… GitLab CI configuration is valid"
          elif [ "${{ inputs.ci_provider }}" = "github" ]; then
            echo "Validating GitHub Actions workflow..."
            if [ -f ".github/workflows/terraform-ci.yml" ]; then
              echo "âœ… GitHub Actions workflow file exists"
              echo "âœ… YAML syntax validation passed during generation"
            else
              echo "âŒ GitHub Actions workflow file not found"
              exit 1
            fi
          elif [ "${{ inputs.ci_provider }}" = "azuredevops" ]; then
            echo "Validating Azure DevOps pipeline..."
            if [ -f "azure-pipelines.yml" ]; then
              echo "âœ… Azure DevOps pipeline file exists"
              echo "âœ… YAML syntax validation passed during generation"
            else
              echo "âŒ Azure DevOps pipeline file not found"
              exit 1
            fi
          else
            echo "âš ï¸  Unknown CI provider: ${{ inputs.ci_provider }}"
            echo "Skipping CI/CD validation"
          fi

      - name: Generate validation report
        run: |
          cat > generated-infra/VALIDATION_REPORT.md << EOF
          # Terraform Validation Report

          ## Project Information
          - **Project Name**: ${{ inputs.project_name }}
          - **Components**: ${{ inputs.components }}
          - **Environments**: ${{ inputs.environments }}
          - **Region**: ${{ inputs.region }}
          - **AWS Account**: ${{ inputs.aws_account_id }}
          - **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Validation Checks

          âœ… Terraform initialization successful
          âœ… Terraform formatting checked
          âœ… Terraform validation passed
          âœ… tflint analysis completed
          âœ… CI/CD configuration validated (${{ inputs.ci_provider }})

          ## Next Steps

          1. Download and extract the artifact
          2. Review the generated infrastructure code
          3. Create tfvars files with your values (one per environment)
          4. Initialize Terraform: \`cd infra/<component> && terraform init\`
          5. Plan changes: \`terraform plan -var-file=../config/<env>.tfvars\`
          6. Apply infrastructure: \`terraform apply -var-file=../config/<env>.tfvars\`

          ## Important Notes

          - This is an MVP version with **local state backend**
          - Configure your AWS credentials before running Terraform
          - Review all configuration files before applying
          - State files will be stored locally in each component directory
          EOF

      - name: Verify generated files
        run: |
          echo "=== Verifying generated files ==="
          echo ""
          echo "Directory structure:"
          ls -la generated-infra/
          echo ""

          # Verify CI/CD configuration file based on provider
          if [ "${{ inputs.ci_provider }}" = "gitlab" ]; then
            if [ -f "generated-infra/.gitlab-ci.yml" ]; then
              echo "âœ… .gitlab-ci.yml exists"
              echo "File size: $(stat -f%z generated-infra/.gitlab-ci.yml 2>/dev/null || stat -c%s generated-infra/.gitlab-ci.yml) bytes"
            else
              echo "âŒ ERROR: .gitlab-ci.yml NOT FOUND"
              exit 1
            fi
          elif [ "${{ inputs.ci_provider }}" = "github" ]; then
            if [ -f "generated-infra/.github/workflows/terraform-ci.yml" ]; then
              echo "âœ… GitHub Actions workflow exists"
              echo "File size: $(stat -f%z generated-infra/.github/workflows/terraform-ci.yml 2>/dev/null || stat -c%s generated-infra/.github/workflows/terraform-ci.yml) bytes"
            else
              echo "âŒ ERROR: .github/workflows/terraform-ci.yml NOT FOUND"
              exit 1
            fi
          elif [ "${{ inputs.ci_provider }}" = "azuredevops" ]; then
            if [ -f "generated-infra/azure-pipelines.yml" ]; then
              echo "âœ… azure-pipelines.yml exists"
              echo "File size: $(stat -f%z generated-infra/azure-pipelines.yml 2>/dev/null || stat -c%s generated-infra/azure-pipelines.yml) bytes"
            else
              echo "âŒ ERROR: azure-pipelines.yml NOT FOUND"
              exit 1
            fi
          fi

          if [ -f "generated-infra/README.md" ]; then
            echo "âœ… README.md exists"
          else
            echo "âŒ ERROR: README.md NOT FOUND"
            exit 1
          fi

          if [ -d "generated-infra/infra" ]; then
            echo "âœ… infra/ directory exists"
            echo "Components: $(ls -d generated-infra/infra/*/ | xargs -n1 basename | tr '\n' ', ' | sed 's/,$//')"
          else
            echo "âŒ ERROR: infra/ directory NOT FOUND"
            exit 1
          fi

      - name: Create archive
        run: |
          cd generated-infra

          # Create ZIP archive excluding temporary files
          zip -r ../infrastructure-${{ inputs.project_name }}-$(date +%Y%m%d-%H%M%S).zip . \
            -x '.terraform/*' \
            -x '.terraform.lock.hcl' \
            -x '*.tfstate' \
            -x '*.tfstate.backup' \
            -x '*.tfplan' \
            -x '.git/*'

          cd ..

          echo "âœ… Archive created successfully"
          ls -lh infrastructure-*.zip

          # Verify archive contents
          echo ""
          echo "Archive contents (first 20 files):"
          unzip -l infrastructure-*.zip | head -30

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-${{ inputs.project_name }}
          path: infrastructure-*.zip
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Infrastructure Generation Complete! (MVP)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Components**: ${{ inputs.components }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environments**: ${{ inputs.environments }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Account**: ${{ inputs.aws_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CI/CD Provider**: ${{ inputs.ci_provider }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform initialization: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform formatting: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform validation: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- tflint analysis: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifact" >> $GITHUB_STEP_SUMMARY
          echo "Download the generated infrastructure archive from the Actions artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download and extract the artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the generated code" >> $GITHUB_STEP_SUMMARY
          echo "3. Create config/<env>.tfvars files" >> $GITHUB_STEP_SUMMARY
          echo "4. Deploy using Terraform (local state)" >> $GITHUB_STEP_SUMMARY
