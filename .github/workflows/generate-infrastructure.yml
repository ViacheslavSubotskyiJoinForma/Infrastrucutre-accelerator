name: Generate Infrastructure Template

run-name: Generate "${{ inputs.project_name }}" infrastructure (${{ inputs.component_preset }})

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name (used for naming resources)'
        required: true
        type: string

      component_preset:
        description: 'Component preset'
        required: true
        type: choice
        options:
          - 'minimal'
          - 'standard'
          - 'full-stack'
          - 'kubernetes'
          - 'custom'
        default: 'standard'

      custom_components:
        description: 'Custom components (if preset=custom): vpc,rds,eks,services,secrets,opensearch,monitoring,common'
        required: false
        type: string
        default: 'vpc,rds,eks,services'

      environments:
        description: 'Environments (comma-separated: dev,uat,prod)'
        required: true
        type: string
        default: 'dev,uat,prod'

      region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'

      state_bucket:
        description: 'S3 bucket for Terraform state (auto-generated if empty)'
        required: false
        type: string

      dynamodb_table:
        description: 'DynamoDB table for state locking (auto-generated if empty)'
        required: false
        type: string

      use_assume_role:
        description: 'Use AWS role assumption'
        required: false
        type: boolean
        default: true

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install jinja2

      - name: Build component list
        id: components
        run: |
          PRESET="${{ inputs.component_preset }}"
          COMPONENTS=""

          case "$PRESET" in
            "minimal")
              # VPC only
              COMPONENTS="vpc"
              ;;
            "standard")
              # VPC, RDS, EKS, Services
              COMPONENTS="vpc,rds,eks,services"
              ;;
            "full-stack")
              # All components except common
              COMPONENTS="vpc,rds,secrets,eks,services,opensearch,monitoring"
              ;;
            "kubernetes")
              # Kubernetes-focused setup
              COMPONENTS="vpc,eks,monitoring"
              ;;
            "custom")
              # Use custom components from input
              COMPONENTS="${{ inputs.custom_components }}"
              ;;
            *)
              echo "Unknown preset: $PRESET"
              exit 1
              ;;
          esac

          echo "components=${COMPONENTS}" >> $GITHUB_OUTPUT
          echo "Preset: $PRESET"
          echo "Selected components: ${COMPONENTS}"

      - name: Generate infrastructure
        run: |
          python3 scripts/generators/generate_infrastructure.py \
            --project-name "${{ inputs.project_name }}" \
            --components "${{ steps.components.outputs.components }}" \
            --environments "${{ inputs.environments }}" \
            --region "${{ inputs.region }}" \
            ${{ inputs.state_bucket && format('--state-bucket {0}', inputs.state_bucket) || '' }} \
            ${{ inputs.dynamodb_table && format('--dynamodb-table {0}', inputs.dynamodb_table) || '' }} \
            ${{ inputs.use_assume_role && '--use-assume-role' || '' }} \
            --output-dir generated-infra

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.4

      - name: Validate Terraform - Init
        run: |
          echo "Validating generated Terraform code..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Initializing $component..."

              cd "$dir"

              # Initialize without backend (for validation only)
              terraform init -backend=false || {
                echo "âŒ Failed to initialize $component"
                exit 1
              }

              cd - > /dev/null
            fi
          done

      - name: Validate Terraform - Format Check
        run: |
          echo "Checking Terraform formatting..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Checking format for $component..."

              cd "$dir"

              terraform fmt -check -recursive || {
                echo "âš ï¸  Warning: $component has formatting issues"
                echo "Running terraform fmt to fix..."
                terraform fmt -recursive
              }

              cd - > /dev/null
            fi
          done

      - name: Validate Terraform - Validate
        run: |
          echo "Validating Terraform configuration..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Validating $component..."

              cd "$dir"

              terraform validate || {
                echo "âŒ Failed to validate $component"
                exit 1
              }

              cd - > /dev/null
            fi
          done

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Run tflint
        continue-on-error: true
        run: |
          echo "Running tflint..."

          for dir in generated-infra/infra/*/ ; do
            if [ -d "$dir" ]; then
              component=$(basename "$dir")
              echo "Linting $component..."

              cd "$dir"
              tflint --init
              tflint || echo "âš ï¸  tflint found issues in $component"
              cd - > /dev/null
            fi
          done

      - name: Generate validation report
        run: |
          cat > generated-infra/VALIDATION_REPORT.md << 'EOF'
          # Terraform Validation Report

          ## Project Information
          - **Project Name**: ${{ inputs.project_name }}
          - **Components**: ${{ steps.components.outputs.components }}
          - **Environments**: ${{ inputs.environments }}
          - **Region**: ${{ inputs.region }}
          - **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Validation Checks

          âœ… Terraform initialization successful
          âœ… Terraform formatting checked
          âœ… Terraform validation passed
          âœ… tflint analysis completed

          ## Next Steps

          1. Download and extract the artifact
          2. Review the generated infrastructure code
          3. Create `infra/config/*.tfvars` files with your environment-specific values
          4. Initialize Terraform: `terraform init -backend-config="key=${ENV}/<component>/tf.state"`
          5. Plan changes: `terraform plan -var-file=../config/${ENV}.tfvars`
          6. Apply infrastructure: `terraform apply -var-file=../config/${ENV}.tfvars`

          ## Important Notes

          - Components must be deployed in the order listed in README.md
          - Configure your AWS credentials before running Terraform
          - Review all configuration files before applying
          - The `.gitlab-ci.yml` file is included for GitLab CI/CD automation
          EOF

      - name: Verify generated files
        run: |
          echo "=== Verifying generated files ==="
          echo ""
          echo "Directory structure:"
          ls -la generated-infra/
          echo ""

          if [ -f "generated-infra/.gitlab-ci.yml" ]; then
            echo "âœ… .gitlab-ci.yml exists"
            echo "File size: $(stat -f%z generated-infra/.gitlab-ci.yml 2>/dev/null || stat -c%s generated-infra/.gitlab-ci.yml) bytes"
          else
            echo "âŒ ERROR: .gitlab-ci.yml NOT FOUND"
            exit 1
          fi

          if [ -f "generated-infra/README.md" ]; then
            echo "âœ… README.md exists"
          else
            echo "âŒ ERROR: README.md NOT FOUND"
            exit 1
          fi

          if [ -d "generated-infra/infra" ]; then
            echo "âœ… infra/ directory exists"
            echo "Components: $(ls -d generated-infra/infra/*/ | xargs -n1 basename | tr '\n' ', ' | sed 's/,$//')"
          else
            echo "âŒ ERROR: infra/ directory NOT FOUND"
            exit 1
          fi

      - name: Create archive
        run: |
          cd generated-infra

          # Create archive excluding temporary files
          tar -czf ../infrastructure-${{ inputs.project_name }}-$(date +%Y%m%d-%H%M%S).tar.gz \
            --exclude='.terraform' \
            --exclude='.terraform.lock.hcl' \
            --exclude='*.tfstate' \
            --exclude='*.tfstate.backup' \
            --exclude='*.tfplan' \
            --exclude='.git' \
            .

          cd ..

          echo "âœ… Archive created successfully"
          ls -lh infrastructure-*.tar.gz

          # Verify archive contents
          echo ""
          echo "Archive contents (first 20 files):"
          tar -tzf infrastructure-*.tar.gz | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-${{ inputs.project_name }}
          path: infrastructure-*.tar.gz
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Infrastructure Generation Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Preset**: ${{ inputs.component_preset }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Components**: ${{ steps.components.outputs.components }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environments**: ${{ inputs.environments }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform initialization: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform formatting: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform validation: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- tflint analysis: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifact" >> $GITHUB_STEP_SUMMARY
          echo "Download the generated infrastructure archive from the Actions artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract and review the code" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure environment-specific .tfvars files" >> $GITHUB_STEP_SUMMARY
          echo "4. Deploy using Terraform or GitLab CI/CD" >> $GITHUB_STEP_SUMMARY
