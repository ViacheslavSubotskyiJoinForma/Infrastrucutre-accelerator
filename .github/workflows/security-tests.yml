name: Security & Tests

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Prevent concurrent test runs for the same workflow
concurrency:
  group: security-tests-${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true  # Cancel in-progress for tests

# Minimal permissions following principle of least privilege
permissions:
  contents: read
  pull-requests: write  # Required for PR comments
  actions: write        # Required for uploading artifacts

env:
  PYTHON_VERSION: '3.12'  # Single Python version for all jobs

jobs:
  security-tests:
    name: Security & Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jinja2 coverage

      - name: Run security validator tests
        run: |
          python -m unittest tests.test_security_validator -v

      - name: Run infrastructure generator tests
        run: |
          python -m unittest tests.test_infrastructure_generator -v
        continue-on-error: true  # Some tests need template files

      - name: Run all tests with coverage
        run: |
          coverage run -m unittest discover -s tests -p 'test_*.py' -v
          coverage report
          coverage html
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

          # Determine badge color
          if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 75" | bc -l) )); then
            COLOR="green"
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          echo "BADGE_COLOR=$COLOR" >> $GITHUB_ENV
        continue-on-error: true

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Run coverage and capture output
            const { execSync } = require('child_process');
            let coverageOutput = '';
            try {
              coverageOutput = execSync('coverage report', { encoding: 'utf-8' });
            } catch (error) {
              coverageOutput = 'Coverage report not available';
            }

            const comment = `## ðŸ“Š Test Coverage Report

            \`\`\`
            ${coverageOutput}
            \`\`\`

            Full HTML report available in workflow artifacts.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true

  frontend-tests:
    name: Frontend Tests & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check JavaScript syntax
        run: |
          echo "ðŸ” Checking JavaScript syntax..."
          # Check all JavaScript files for syntax errors
          for file in docs/js/*.js; do
            echo "Checking $file..."
            node -c "$file" || {
              echo "âŒ Syntax error in $file"
              exit 1
            }
          done
          echo "âœ… All JavaScript files have valid syntax"

      - name: Run npm tests
        run: |
          npm test

      - name: Lint JavaScript with ESLint (optional)
        run: |
          # Install ESLint
          npm install --no-save eslint

          # Create basic ESLint config
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true,
              "node": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": 2021,
              "sourceType": "module"
            },
            "rules": {
              "no-unused-vars": ["warn"],
              "no-undef": ["error"],
              "no-redeclare": ["error"],
              "no-const-assign": ["error"]
            }
          }
          EOF

          # Run ESLint on all JS files
          npx eslint docs/js/*.js || true
        continue-on-error: true

  web-security-tests:
    name: Web Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Run web security tests
        run: |
          # Create a simple test runner for headless browser
          cat > run_web_tests.js << 'EOF'
          const { chromium } = require('playwright');
          const path = require('path');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();

            // Listen for console messages
            let testResults = { passed: 0, failed: 0, total: 0 };

            page.on('console', msg => {
              const text = msg.text();
              if (text.includes('âœ“ PASS')) {
                testResults.passed++;
                testResults.total++;
              } else if (text.includes('âœ— FAIL')) {
                testResults.failed++;
                testResults.total++;
              }
            });

            // Load test page
            const testPath = 'file://' + path.resolve('tests/test_web_security.html');
            await page.goto(testPath);

            // Wait for tests to complete
            await page.waitForTimeout(5000);

            console.log('\nðŸ“Š Web Security Test Results:');
            console.log(`Total: ${testResults.total}`);
            console.log(`Passed: ${testResults.passed}`);
            console.log(`Failed: ${testResults.failed}`);

            await browser.close();

            // Exit with error if tests failed
            if (testResults.failed > 0) {
              process.exit(1);
            }
          })();
          EOF

          node run_web_tests.js

      - name: Web tests summary
        if: always()
        run: |
          echo "âœ… Web security tests completed"
          echo "Check logs above for detailed results"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r scripts/ -f json -o bandit-report.json || true
          bandit -r scripts/ || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@v3.90.13
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install flake8 pylint mypy

      - name: Run flake8
        run: |
          flake8 scripts/ tests/ --max-line-length=100 --ignore=E501,W503 || true

      - name: Run pylint
        run: |
          pylint scripts/ --max-line-length=100 --disable=C0111,R0913,R0914 || true
        continue-on-error: true

      - name: Run mypy type checking
        run: |
          mypy scripts/ --ignore-missing-imports || true
        continue-on-error: true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [security-tests, frontend-tests, web-security-tests, security-scan, code-quality]
    if: always()

    steps:
      - name: Generate test summary
        run: |
          echo "## ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tests | ${{ needs.security-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests & Lint | ${{ needs.frontend-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web Security Tests | ${{ needs.web-security-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed coverage report in workflow artifacts." >> $GITHUB_STEP_SUMMARY
